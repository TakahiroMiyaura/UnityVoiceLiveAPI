<Project>
  <!--
    Unity Path Detection for VoiceLiveAPI.Unity

    This file automatically detects the Unity installation path using:
    1. UnityPath.props (if exists) - fastest, generated by Setup-UnityPath.ps1
    2. Unity-generated csproj (fallback) - requires Unity Editor to have been opened once

    Usage:
      - Run 'pwsh scripts/Setup-UnityPath.ps1' to generate UnityPath.props
      - Or simply open Unity Editor once to generate project files
  -->

  <PropertyGroup>
    <!-- Relative path definitions -->
    <UnityProjectRoot>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)..\Unity\UnityVoiceLiveAPI'))</UnityProjectRoot>
    <UnityGeneratedCsproj>$(UnityProjectRoot)\Com.Reseul.Azure.AI.VoiceLiveAPI.Unity.csproj</UnityGeneratedCsproj>
    <UnityPathPropsFile>$(MSBuildProjectDirectory)\UnityPath.props</UnityPathPropsFile>
    <ScriptAssembliesPath>$(UnityProjectRoot)\Library\ScriptAssemblies</ScriptAssembliesPath>
  </PropertyGroup>

  <!-- Priority 1: Use UnityPath.props if exists (fastest) -->
  <Import Project="$(UnityPathPropsFile)" Condition="Exists('$(UnityPathPropsFile)')" />

  <!-- Priority 2: If UnityPath.props not found, extract from Unity-generated csproj -->
  <PropertyGroup Condition="'$(UNITY_PATH)' == '' And Exists('$(UnityGeneratedCsproj)')">
    <_UnityCsprojContent>$([System.IO.File]::ReadAllText('$(UnityGeneratedCsproj)'))</_UnityCsprojContent>
    <_ExtractedPath>$([System.Text.RegularExpressions.Regex]::Match($(_UnityCsprojContent), 'HintPath&gt;(.+?)\\Editor\\Data\\Managed').Groups[1].Value)</_ExtractedPath>
    <UNITY_PATH Condition="'$(_ExtractedPath)' != ''">$(_ExtractedPath)</UNITY_PATH>
  </PropertyGroup>

  <!-- Priority 3: Mark as error if neither source is available -->
  <PropertyGroup Condition="'$(UNITY_PATH)' == ''">
    <_UnityPathError>true</_UnityPathError>
  </PropertyGroup>

  <!-- Error target: Show guidance when Unity path cannot be detected -->
  <Target Name="CheckUnityPathSetup" BeforeTargets="ResolveAssemblyReferences" Condition="'$(_UnityPathError)' == 'true'">
    <Error Text="Unity path not detected. Please either:%0A  1. Run 'pwsh scripts/Setup-UnityPath.ps1'%0A  2. Open Unity Editor once to generate project files%0A%0AUnity project path: $(UnityProjectRoot)" />
  </Target>

  <!-- Debug: Show detected Unity path during build -->
  <Target Name="ShowUnityPath" BeforeTargets="ResolveAssemblyReferences" Condition="'$(UNITY_PATH)' != '' And '$(UNITY_PATH_SILENT)' != 'true'">
    <Message Importance="High" Text="Unity path: $(UNITY_PATH)" />
  </Target>

</Project>
